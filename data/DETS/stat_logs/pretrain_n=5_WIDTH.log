Namespace(target_csv='enthalpy/atct.csv', source_csv='enthalpy/wudily_cho.csv', pretrained='DETS/new_df_core.pt', batch_size=128, epochs=200, ft_epochs=150, hidden_dim=256, layers=3, dropout=0.2, lr=0.0005, wd=1e-06, patience=50, device='cuda:0', num_prototypes=5, tau_high=0.85, sigma_0=0.15, gamma=0.5, alpha=0.9, w_min=0.0001)
--- DETS Full Pipeline: Stabilized Loss & Orthogonal Init ---
Device: cuda:0
-> Loading TARGET (Experiment) Dataset: enthalpy/atct.csv
Processing enthalpy/atct.csv...
-> Loaded 358 valid molecules from 358 rows.
-> Loading SOURCE (Theory) Dataset: enthalpy/wudily_cho.csv
Processing enthalpy/wudily_cho.csv...
-> Loaded 6074 valid molecules from 6074 rows.
-> Target Statistics: Mean=14.0561, Std=51.2793
-> Loading base pretrained weights from DETS/new_df_core.pt...

==================================================
PHASE 1: DETS Source Training
==================================================
-> Extracting Anchors from Target (Experiment) Data...
   Running K-Means (K=5)...
-> Anchors Established: 5 prototypes.
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.2947
-> [Epoch 1] HighConf>0.1: 1844 (30.4%)
[P1] Epoch 001 | Loss 0.9828 | Val MAE 70.4087 | Acc 2.78%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.2564
-> [Epoch 2] HighConf>0.1: 1822 (30.0%)
[P1] Epoch 002 | Loss 0.1182 | Val MAE 51.8786 | Acc 0.00%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.2057
-> [Epoch 3] HighConf>0.1: 1860 (30.6%)
[P1] Epoch 003 | Loss 0.0346 | Val MAE 38.2793 | Acc 2.78%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.2015
-> [Epoch 4] HighConf>0.1: 1833 (30.2%)
[P1] Epoch 004 | Loss 0.0201 | Val MAE 51.6736 | Acc 2.78%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1968
-> [Epoch 5] HighConf>0.1: 1833 (30.2%)
[P1] Epoch 005 | Loss 0.0174 | Val MAE 50.5528 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1805
-> [Epoch 6] HighConf>0.1: 1854 (30.5%)
[P1] Epoch 006 | Loss 0.0162 | Val MAE 51.0760 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1929
-> [Epoch 7] HighConf>0.1: 1834 (30.2%)
[P1] Epoch 007 | Loss 0.0146 | Val MAE 53.4207 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1867
-> [Epoch 8] HighConf>0.1: 1835 (30.2%)
[P1] Epoch 008 | Loss 0.0127 | Val MAE 58.5885 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1821
-> [Epoch 9] HighConf>0.1: 1829 (30.1%)
[P1] Epoch 009 | Loss 0.0139 | Val MAE 66.4951 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1791
-> [Epoch 10] HighConf>0.1: 1826 (30.1%)
[P1] Epoch 010 | Loss 0.0118 | Val MAE 65.5098 | Acc 5.56%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1791
-> [Epoch 11] HighConf>0.1: 1833 (30.2%)
[P1] Epoch 011 | Loss 0.0119 | Val MAE 67.8878 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1792
-> [Epoch 12] HighConf>0.1: 1829 (30.1%)
[P1] Epoch 012 | Loss 0.0118 | Val MAE 69.3133 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1862
-> [Epoch 13] HighConf>0.1: 1825 (30.0%)
[P1] Epoch 013 | Loss 0.0103 | Val MAE 64.8661 | Acc 2.78%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1835
-> [Epoch 14] HighConf>0.1: 1823 (30.0%)
[P1] Epoch 014 | Loss 0.0116 | Val MAE 78.2982 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1838
-> [Epoch 15] HighConf>0.1: 1850 (30.5%)
[P1] Epoch 015 | Loss 0.0106 | Val MAE 75.3131 | Acc 5.56%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1805
-> [Epoch 16] HighConf>0.1: 1840 (30.3%)
[P1] Epoch 016 | Loss 0.0115 | Val MAE 69.2460 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1855
-> [Epoch 17] HighConf>0.1: 1824 (30.0%)
[P1] Epoch 017 | Loss 0.0111 | Val MAE 70.2727 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1791
-> [Epoch 18] HighConf>0.1: 1836 (30.2%)
[P1] Epoch 018 | Loss 0.0100 | Val MAE 63.2463 | Acc 5.56%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1769
-> [Epoch 19] HighConf>0.1: 1845 (30.4%)
[P1] Epoch 019 | Loss 0.0101 | Val MAE 66.2181 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1851
-> [Epoch 20] HighConf>0.1: 1822 (30.0%)
[P1] Epoch 020 | Loss 0.0104 | Val MAE 67.7069 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1773
-> [Epoch 21] HighConf>0.1: 1829 (30.1%)
[P1] Epoch 021 | Loss 0.0092 | Val MAE 68.6202 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1785
-> [Epoch 22] HighConf>0.1: 1815 (29.9%)
[P1] Epoch 022 | Loss 0.0086 | Val MAE 71.4879 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1754
-> [Epoch 23] HighConf>0.1: 1828 (30.1%)
[P1] Epoch 023 | Loss 0.0098 | Val MAE 72.3829 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1819
-> [Epoch 24] HighConf>0.1: 1846 (30.4%)
[P1] Epoch 024 | Loss 0.0092 | Val MAE 50.5577 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1808
-> [Epoch 25] HighConf>0.1: 1841 (30.3%)
[P1] Epoch 025 | Loss 0.0111 | Val MAE 50.1359 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1775
-> [Epoch 26] HighConf>0.1: 1837 (30.2%)
[P1] Epoch 026 | Loss 0.0094 | Val MAE 51.8007 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1754
-> [Epoch 27] HighConf>0.1: 1814 (29.9%)
[P1] Epoch 027 | Loss 0.0084 | Val MAE 59.8294 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1783
-> [Epoch 28] HighConf>0.1: 1822 (30.0%)
[P1] Epoch 028 | Loss 0.0080 | Val MAE 71.5919 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1779
-> [Epoch 29] HighConf>0.1: 1822 (30.0%)
[P1] Epoch 029 | Loss 0.0085 | Val MAE 68.4133 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1725
-> [Epoch 30] HighConf>0.1: 1814 (29.9%)
[P1] Epoch 030 | Loss 0.0086 | Val MAE 78.6656 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1702
-> [Epoch 31] HighConf>0.1: 1760 (29.0%)
[P1] Epoch 031 | Loss 0.0078 | Val MAE 81.7174 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1710
-> [Epoch 32] HighConf>0.1: 1761 (29.0%)
[P1] Epoch 032 | Loss 0.0079 | Val MAE 64.6679 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1757
-> [Epoch 33] HighConf>0.1: 1849 (30.4%)
[P1] Epoch 033 | Loss 0.0070 | Val MAE 70.6828 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1710
-> [Epoch 34] HighConf>0.1: 1811 (29.8%)
[P1] Epoch 034 | Loss 0.0079 | Val MAE 87.3549 | Acc 5.56%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1750
-> [Epoch 35] HighConf>0.1: 1836 (30.2%)
[P1] Epoch 035 | Loss 0.0077 | Val MAE 68.7929 | Acc 16.67%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1698
-> [Epoch 36] HighConf>0.1: 1767 (29.1%)
[P1] Epoch 036 | Loss 0.0076 | Val MAE 64.4102 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1710
-> [Epoch 37] HighConf>0.1: 1786 (29.4%)
[P1] Epoch 037 | Loss 0.0105 | Val MAE 67.7759 | Acc 16.67%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1705
-> [Epoch 38] HighConf>0.1: 1813 (29.8%)
[P1] Epoch 038 | Loss 0.0073 | Val MAE 61.3103 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1730
-> [Epoch 39] HighConf>0.1: 1792 (29.5%)
[P1] Epoch 039 | Loss 0.0073 | Val MAE 67.5929 | Acc 19.44%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1721
-> [Epoch 40] HighConf>0.1: 1752 (28.8%)
[P1] Epoch 040 | Loss 0.0087 | Val MAE 61.8917 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1736
-> [Epoch 41] HighConf>0.1: 1791 (29.5%)
[P1] Epoch 041 | Loss 0.0071 | Val MAE 55.3125 | Acc 5.56%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1736
-> [Epoch 42] HighConf>0.1: 1837 (30.2%)
[P1] Epoch 042 | Loss 0.0078 | Val MAE 56.4648 | Acc 8.33%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1744
-> [Epoch 43] HighConf>0.1: 1833 (30.2%)
[P1] Epoch 043 | Loss 0.0076 | Val MAE 58.2406 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1761
-> [Epoch 44] HighConf>0.1: 1832 (30.2%)
[P1] Epoch 044 | Loss 0.0079 | Val MAE 62.8086 | Acc 5.56%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1727
-> [Epoch 45] HighConf>0.1: 1811 (29.8%)
[P1] Epoch 045 | Loss 0.0073 | Val MAE 66.9819 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1706
-> [Epoch 46] HighConf>0.1: 1774 (29.2%)
[P1] Epoch 046 | Loss 0.0087 | Val MAE 67.8394 | Acc 11.11%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1773
-> [Epoch 47] HighConf>0.1: 1803 (29.7%)
[P1] Epoch 047 | Loss 0.0077 | Val MAE 69.5923 | Acc 22.22%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1707
-> [Epoch 48] HighConf>0.1: 1740 (28.6%)
[P1] Epoch 048 | Loss 0.0071 | Val MAE 62.4171 | Acc 0.00%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1731
-> [Epoch 49] HighConf>0.1: 1819 (29.9%)
[P1] Epoch 049 | Loss 0.0075 | Val MAE 72.7184 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1725
-> [Epoch 50] HighConf>0.1: 1820 (30.0%)
[P1] Epoch 050 | Loss 0.0084 | Val MAE 68.3544 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1776
-> [Epoch 51] HighConf>0.1: 1826 (30.1%)
[P1] Epoch 051 | Loss 0.0084 | Val MAE 67.8397 | Acc 2.78%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1757
-> [Epoch 52] HighConf>0.1: 1821 (30.0%)
[P1] Epoch 052 | Loss 0.0073 | Val MAE 68.5461 | Acc 13.89%
   [Debug] Range Filter dropped 213 molecules (Out of [-114.1, 142.3]).
   [Debug] Active Weights Mean: 0.1756
-> [Epoch 53] HighConf>0.1: 1805 (29.7%)
[P1] Epoch 053 | Loss 0.0074 | Val MAE 71.3148 | Acc 13.89%
Phase 1 Early stopping.
------------------------------------------------------------
[phase1 RESULT] Performance on Test Set:
   MAE:      81.4852 kcal/mol
   RMSE:     118.1262 kcal/mol
   MAPE:     368.03 %
   Acc(10%): 2.78 %  <-- Key Metric
------------------------------------------------------------

==================================================
PHASE 2: Target Fine-tuning
   Strategy: Freeze GNN first -> Align Head -> Unfreeze All
==================================================
>>> Stage 2.1: Aligning Prediction Head (Backbone Frozen)...
[P2-Head] Epoch 10 | Val MAE 32.5920 | Acc 2.78%
[P2-Head] Epoch 20 | Val MAE 31.7016 | Acc 0.00%
[P2-Head] Epoch 30 | Val MAE 31.9258 | Acc 0.00%
[P2-Head] Epoch 40 | Val MAE 31.8876 | Acc 2.78%
[P2-Head] Epoch 50 | Val MAE 31.1873 | Acc 0.00%
[P2-Head] Epoch 60 | Val MAE 31.8877 | Acc 2.78%
[P2-Head] Epoch 70 | Val MAE 31.9064 | Acc 5.56%
[P2-Head] Epoch 80 | Val MAE 32.3233 | Acc 5.56%
[P2-Head] Epoch 90 | Val MAE 32.8155 | Acc 0.00%
[P2-Head] Epoch 100 | Val MAE 30.8525 | Acc 5.56%
[P2-Head] Epoch 110 | Val MAE 30.0829 | Acc 2.78%
[P2-Head] Epoch 120 | Val MAE 30.5177 | Acc 8.33%
[P2-Head] Epoch 130 | Val MAE 31.1020 | Acc 5.56%
[P2-Head] Epoch 140 | Val MAE 31.9747 | Acc 0.00%
[P2-Head] Epoch 150 | Val MAE 30.9274 | Acc 0.00%

>>> Stage 2.2: Fine-tuning Whole Model...
[P2-Full] Epoch 010 | Loss 0.5485 | Val MAE 31.3920 | Acc 0.00%
[P2-Full] Epoch 020 | Loss 0.5496 | Val MAE 31.9221 | Acc 2.78%
[P2-Full] Epoch 030 | Loss 0.5976 | Val MAE 30.8849 | Acc 5.56%
[P2-Full] Epoch 040 | Loss 0.5447 | Val MAE 31.1897 | Acc 5.56%
[P2-Full] Epoch 050 | Loss 0.4831 | Val MAE 31.1595 | Acc 5.56%
[P2-Full] Epoch 060 | Loss 0.4905 | Val MAE 32.5493 | Acc 2.78%
[P2-Full] Epoch 070 | Loss 0.4669 | Val MAE 31.6437 | Acc 8.33%
[P2-Full] Epoch 080 | Loss 0.4319 | Val MAE 31.2279 | Acc 8.33%
Phase 2 Early stopping.

>>> Testing Final Model...
------------------------------------------------------------
[FINAL RESULT] Performance on Test Set:
   MAE:      26.2304 kcal/mol
   RMSE:     34.4638 kcal/mol
   MAPE:     100.76 %
   Acc(10%): 11.11 %  <-- Key Metric
------------------------------------------------------------
